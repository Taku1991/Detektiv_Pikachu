name: ğŸš€ Build and Release

on:
  release:
    types: [published]
  workflow_dispatch: # Erlaubt manuelles Triggern

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”¨ Build Executables
      run: |
        python build_exe.py
        
    - name: ğŸ“ Create Release Archive
      run: |
        Compress-Archive -Path release\* -DestinationPath DetektivPikachu-Windows-${{ github.ref_name }}.zip
        
    - name: ğŸ“Š Show Release Contents
      run: |
        Write-Host "=== Release Verzeichnis ===" -ForegroundColor Green
        Get-ChildItem release\ -Recurse | Select-Object Name, Length | Format-Table
        Write-Host "=== ZIP-Datei ===" -ForegroundColor Green
        Get-ChildItem DetektivPikachu-Windows-${{ github.ref_name }}.zip | Select-Object Name, Length | Format-Table
        
    - name: ğŸ”¼ Upload to Release
      uses: ncipollo/release-action@v1
      if: github.event_name == 'release'
      with:
        artifacts: "DetektivPikachu-Windows-${{ github.ref_name }}.zip"
        token: ${{ secrets.PAT_TOKEN }}
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        
    - name: ğŸ“¤ Upload Build Artifact (for manual runs)
      uses: actions/upload-artifact@v4
      if: github.event_name == 'workflow_dispatch'
      with:
        name: DetektivPikachu-Windows-Build
        path: DetektivPikachu-Windows-${{ github.ref_name }}.zip
        retention-days: 30

  update-release-notes:
    runs-on: ubuntu-latest
    needs: build-windows
    if: github.event_name == 'release'
    
    steps:
    - name: ğŸ“ Update Release Notes
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const release = await github.rest.repos.getRelease({
            owner,
            repo,
            release_id: context.payload.release.id
          });
          
          const additionalNotes = `
          
          ## ğŸ“¦ Installation (Windows EXE)
          
          1. **Lade die ZIP-Datei herunter**: \`DetektivPikachu-Windows-${{ github.ref_name }}.zip\`
          2. **Entpacke** die Datei in einen Ordner deiner Wahl
          3. **Starten**: Doppelklick auf \`Detektiv_Pikachu_starten.bat\` oder \`DetektivPikachu.exe\`
          4. **Erste Einrichtung**: Bot fragt automatisch nach den Bot-Tokens
          5. **Fertig**: Bot startet automatisch nach der Eingabe
          
          ## ğŸ“‚ Verzeichnisstruktur nach Installation
          
          \`\`\`
          DetektivPikachu/
          â”œâ”€â”€ ğŸš€ DetektivPikachu.exe              # Haupt-EXE (All-in-One)
          â”œâ”€â”€ ğŸ“ _internal/                       # PyInstaller Dependencies
          â”œâ”€â”€ ğŸ¯ Detektiv_Pikachu_starten.bat    # Einfaches Start-Skript
          â”œâ”€â”€ ğŸ“ data/                            # Bot-Daten (automatisch erstellt)
          â”‚   â”œâ”€â”€ json/                           # Status & Verlauf
          â”‚   â”œâ”€â”€ logs/                           # Log-Dateien
          â”‚   â””â”€â”€ gif/                            # GIF-Cache
          â”œâ”€â”€ ğŸ“„ .env                             # Konfiguration (automatisch erstellt)
          â”œâ”€â”€ ğŸ“„ README.md                        # VollstÃ¤ndige Dokumentation
          â””â”€â”€ ğŸ“„ LICENSE                          # MIT Lizenz
          \`\`\`
          
          ## âœ¨ Neue Features dieser Version
          
          - âœ… **Ultra-Einfaches Setup** - Nur EXE starten â†’ Tokens eingeben â†’ fertig!
          - âœ… **Automatische Token-Abfrage** - Keine manuellen Konfigurationsdateien nÃ¶tig
          - âœ… **Ein-Klick-Start** - Detektiv_Pikachu_starten.bat macht alles automatisch
          - âœ… **Intelligente Validierung** - ÃœberprÃ¼ft Token-Format automatisch
          - âœ… **Dual-Bot-System** - Haupt-Bot + Helper-Bot mit Token-Balancing
          - âœ… **Channel-Lock-System** - Automatische Rollensperrung bei Problemen
          - âœ… **Kein Setup-Tool nÃ¶tig** - Alles direkt in der EXE integriert
          
          ## ğŸš€ Super-Schnellstart (nur 3 Schritte!)
          
          1. **ZIP entpacken**
          2. **Detektiv_Pikachu_starten.bat** ausfÃ¼hren
          3. **Bot-Tokens eingeben** (nur beim ersten Mal)
          
          **Das war's!** ğŸ‰
          
          ## ğŸ”§ Erweiterte Installation (Python-Entwickler)
          
          \`\`\`bash
          git clone https://github.com/${{ github.repository }}.git
          cd Detektiv_Pikachu
          pip install -r requirements.txt
          python launcher.py          # Startet beide Bots (fragt nach Tokens falls nÃ¶tig)
          \`\`\`
          
          ## ğŸ”‘ Bot-Tokens erstellen
          
          1. Gehe zu [Discord Developer Portal](https://discord.com/developers/applications)
          2. Erstelle zwei neue Applications
          3. Gehe zu "Bot" â†’ "Reset Token" fÃ¼r jeden Bot
          4. Kopiere die Tokens und gib sie beim ersten Start ein
          
          ## ğŸ› Problembehandlung
          
          - **Token-Probleme**: LÃ¶sche die \`.env\` Datei und starte erneut fÃ¼r neue Token-Eingabe
          - **"Import Error"**: Nutze die EXE-Version oder installiere \`pip install -r requirements.txt\`
          - **Bot startet nicht**: ÃœberprÃ¼fe Internetverbindung und Token-GÃ¼ltigkeit
          - **Weitere Hilfe**: [Discord Server](https://discord.gg/pokemonhideout)
          `;
          
          await github.rest.repos.updateRelease({
            owner,
            repo,
            release_id: context.payload.release.id,
            body: release.data.body + additionalNotes
          });