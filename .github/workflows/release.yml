name: 🚀 Build and Release

on:
  release:
    types: [published]
  workflow_dispatch: # Erlaubt manuelles Triggern

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 🔨 Build Executables
      run: |
        python build_exe.py
        
    - name: 📁 Create Release Archive
      run: |
        Compress-Archive -Path release\* -DestinationPath DetektivPikachu-Windows-${{ github.ref_name }}.zip
        
    - name: 📊 Show Release Contents
      run: |
        Write-Host "=== Release Verzeichnis ===" -ForegroundColor Green
        Get-ChildItem release\ -Recurse | Select-Object Name, Length | Format-Table
        Write-Host "=== ZIP-Datei ===" -ForegroundColor Green
        Get-ChildItem DetektivPikachu-Windows-${{ github.ref_name }}.zip | Select-Object Name, Length | Format-Table
        
    - name: 🔼 Upload to Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'release'
      with:
        files: DetektivPikachu-Windows-${{ github.ref_name }}.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 📤 Upload Build Artifact (for manual runs)
      uses: actions/upload-artifact@v4
      if: github.event_name == 'workflow_dispatch'
      with:
        name: DetektivPikachu-Windows-Build
        path: DetektivPikachu-Windows-${{ github.ref_name }}.zip
        retention-days: 30

  update-release-notes:
    runs-on: ubuntu-latest
    needs: build-windows
    if: github.event_name == 'release'
    
    steps:
    - name: 📝 Update Release Notes
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const release = await github.rest.repos.getRelease({
            owner,
            repo,
            release_id: context.payload.release.id
          });
          
          const additionalNotes = `
          
          ## 📦 Installation (Windows EXE)
          
          1. **Lade die ZIP-Datei herunter**: \`DetektivPikachu-Windows-${{ github.ref_name }}.zip\`
          2. **Entpacke** die Datei in einen Ordner deiner Wahl
          3. **Konfiguration**:
             - Kopiere \`config/.env.example\` nach \`config/.env\`
             - Öffne \`config/.env\` mit einem Texteditor
             - Fülle deine Discord Bot-Tokens ein
          4. **Starten**:
             - Doppelklick auf \`Detektiv_Pikachu_starten.bat\` (empfohlen - startet beide Bots)
             - Alternative: Starte \`DetektivPikachu.exe\` direkt
          
          ## 📂 Verzeichnisstruktur nach Installation
          
          \`\`\`
          DetektivPikachu/
          ├── 🚀 DetektivPikachu.exe          # Haupt-EXE (startet beide Bots)
          ├── 📁 _internal/                   # PyInstaller Dependencies
          ├── 📁 config/                      # Konfiguration (.env hier ablegen)
          │   └── .env.example                # Konfigurationsvorlage
          ├── 📁 data/                        # Bot-Daten (automatisch erstellt)
          │   ├── json/                       # Status & Verlauf
          │   ├── logs/                       # Log-Dateien
          │   └── gif/                        # GIF-Cache
          ├── 📄 Detektiv_Pikachu_starten.bat # Benutzerfreundliches Start-Skript
          ├── 📄 README.md                    # Vollständige Dokumentation
          └── 📄 LICENSE                      # MIT Lizenz
          \`\`\`
          
          ## ✨ Features dieser Version
          
          - ✅ **All-in-One EXE** - Eine EXE startet beide Bots gleichzeitig
          - ✅ **Detektiv Pikachu Icon** - Schönes Icon für die EXE
          - ✅ **Externe Konfiguration** - Alle Daten außerhalb der EXE
          - ✅ **Einfache Installation** - ZIP entpacken und starten
          - ✅ **Benutzerfreundliches Start-Skript** - Mit Hilfe und Fehlererkennung
          - ✅ **Automatisches Logging** - Mit Rotation und Komprimierung
          - ✅ **Channel-Lock-System** - Automatische Rollensperrung bei Problemen
          
          ## 🔧 Erweiterte Installation (Python)
          
          Wenn du lieber mit Python arbeiten möchtest:
          
          \`\`\`bash
          git clone https://github.com/${{ github.repository }}.git
          cd Detektiv_Pikachu
          pip install -r requirements.txt
          # .env-Datei konfigurieren
          python launcher.py  # Beide Bots (empfohlen)
          # ODER separat:
          python main.py      # Nur Haupt-Bot
          python helper_bot.py # Nur Helper-Bot
          \`\`\`
          
          ## 🐛 Problembehandlung
          
          - **"Config/.env nicht gefunden"**: Kopiere \`config/.env.example\` nach \`config/.env\`
          - **"Import Error"**: Nutze die EXE-Version oder installiere \`pip install -r requirements.txt\`
          - **Bot startet nicht**: Überprüfe die Bot-Tokens in der \`.env\`-Datei
          - **Weitere Hilfe**: [Discord Server](https://discord.gg/pokemonhideout)
          `;
          
          await github.rest.repos.updateRelease({
            owner,
            repo,
            release_id: context.payload.release.id,
            body: release.data.body + additionalNotes
          });