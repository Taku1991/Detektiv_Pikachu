name: ğŸš€ Build and Release

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'          # Triggert bei Tags wie v1.0.0, v2.1.3, etc.
  workflow_dispatch:   # Erlaubt manuelles Triggern

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    outputs:
      release_id: ${{ steps.create_release.outputs.result }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“ Extract Tag Info
      id: tag_info
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Tag: $TAG"
        
    - name: ğŸ¯ Create Release
      id: create_release
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const tag = '${{ steps.tag_info.outputs.tag }}';
          
          const releaseBody = [
            '## ğŸš€ Detektiv Pikachu ' + tag,
            '',
            '### âœ¨ Neue Features & Verbesserungen',
            '- ğŸš€ **Performance-Optimierung**: Bis zu 70% schnellere Bot-Startzeit',
            '- âš¡ **Lazy Loading**: Manager werden erst bei Bedarf geladen', 
            '- ğŸ”„ **Paralleles Cog-Loading**: Alle Extensions laden gleichzeitig',
            '- â±ï¸ **Smart Timeouts**: Verhindert ewiges Warten beim Start',
            '- ğŸ“Š **Performance-Monitoring**: Zeigt genau an, wie lange der Start dauert',
            '',
            '### ğŸ“¦ Download & Installation',
            'Die Windows-EXE wird automatisch gebaut und ist in wenigen Minuten verfÃ¼gbar!',
            '',
            '---',
            '*Automatisch erstellt beim Tag-Push* ğŸ¤–'
          ].join('\n');
          
          try {
            const release = await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tag,
              name: 'Detektiv Pikachu ' + tag,
              body: releaseBody,
              draft: false,
              prerelease: tag.includes('beta') || tag.includes('alpha')
            });
            
            console.log('Release erstellt: ' + release.data.html_url);
            return release.data.id;
          } catch (error) {
            console.error('Fehler beim Erstellen des Release:', error);
            throw error;
          }

  build-windows:
    runs-on: windows-latest
    needs: [create-release]
    if: always() && (github.event_name == 'release' || startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”¨ Build Executables
      run: |
        python build_exe.py
        
    - name: ğŸ“ Create Release Archive
      run: |
        $tagName = if ($env:GITHUB_REF -match '^refs/tags/(.+)$') { $matches[1] } else { "manual-build" }
        Compress-Archive -Path release\* -DestinationPath "DetektivPikachu-Windows-$tagName.zip"
        echo "ARCHIVE_NAME=DetektivPikachu-Windows-$tagName.zip" | Out-File -FilePath $env:GITHUB_ENV -Append
        
    - name: ğŸ“Š Show Release Contents
      run: |
        Write-Host "=== Release Verzeichnis ===" -ForegroundColor Green
        Get-ChildItem release\ -Recurse | Select-Object Name, Length | Format-Table
        Write-Host "=== ZIP-Datei ===" -ForegroundColor Green
        Get-ChildItem $env:ARCHIVE_NAME | Select-Object Name, Length | Format-Table
        
    - name: ğŸ”¼ Upload to Release (Tag-Push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: ncipollo/release-action@v1
      with:
        artifacts: "${{ env.ARCHIVE_NAME }}"
        token: ${{ secrets.PAT_TOKEN }}
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        tag: ${{ github.ref_name }}
        
    - name: ğŸ”¼ Upload to Release (Manual/Published)
      if: github.event_name == 'release'
      uses: ncipollo/release-action@v1
      with:
        artifacts: "${{ env.ARCHIVE_NAME }}"
        token: ${{ secrets.PAT_TOKEN }}
        allowUpdates: true
        omitBodyDuringUpdate: true
        omitNameDuringUpdate: true
        
    - name: ğŸ“¤ Upload Build Artifact (for manual runs)
      uses: actions/upload-artifact@v4
      if: github.event_name == 'workflow_dispatch'
      with:
        name: DetektivPikachu-Windows-Build
        path: "${{ env.ARCHIVE_NAME }}"
        retention-days: 30

  update-release-notes:
    runs-on: ubuntu-latest
    needs: [build-windows, create-release]
    if: always() && (github.event_name == 'release' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: ğŸ“ Update Release Notes
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          
          // Finde das Release
          let release;
          if (context.eventName === 'release') {
            release = await github.rest.repos.getRelease({
              owner,
              repo,
              release_id: context.payload.release.id
            });
          } else {
            // Tag-basiert - finde Release by Tag
            const tag = context.ref.replace('refs/tags/', '');
            try {
              release = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag: tag
              });
            } catch (error) {
              console.log('Release nicht gefunden, Ã¼berspringe Update');
              return;
            }
          }
          
          const tagName = release.data.tag_name;
          const additionalNotes = [
            '',
            '',
            '## ğŸ“¦ Installation (Windows EXE)',
            '',
            '1. **Lade die ZIP-Datei herunter**: `DetektivPikachu-Windows-' + tagName + '.zip`',
            '2. **Entpacke** die Datei in einen Ordner deiner Wahl',
            '3. **Starten**: Doppelklick auf `Detektiv_Pikachu_starten.bat` oder `DetektivPikachu.exe`',
            '4. **Erste Einrichtung**: Bot fragt automatisch nach den Bot-Tokens',
            '5. **Fertig**: Bot startet automatisch nach der Eingabe',
            '',
            '## ğŸ“‚ Verzeichnisstruktur nach Installation',
            '',
            '```',
            'DetektivPikachu/',
            'â”œâ”€â”€ ğŸš€ DetektivPikachu.exe              # Haupt-EXE (All-in-One)',
            'â”œâ”€â”€ ğŸ“ _internal/                       # PyInstaller Dependencies',
            'â”œâ”€â”€ ğŸ¯ Detektiv_Pikachu_starten.bat    # Einfaches Start-Skript',
            'â”œâ”€â”€ ğŸ“ data/                            # Bot-Daten (automatisch erstellt)',
            'â”‚   â”œâ”€â”€ json/                           # Status & Verlauf',
            'â”‚   â”œâ”€â”€ logs/                           # Log-Dateien',
            'â”‚   â””â”€â”€ gif/                            # GIF-Cache',
            'â”œâ”€â”€ ğŸ“„ .env                             # Konfiguration (automatisch erstellt)',
            'â”œâ”€â”€ ğŸ“„ README.md                        # VollstÃ¤ndige Dokumentation',
            'â””â”€â”€ ğŸ“„ LICENSE                          # MIT Lizenz',
            '```',
            '',
            '## ğŸš€ Super-Schnellstart (nur 3 Schritte!)',
            '',
            '1. **ZIP entpacken**',
            '2. **Detektiv_Pikachu_starten.bat** ausfÃ¼hren',
            '3. **Bot-Tokens eingeben** (nur beim ersten Mal)',
            '',
            '**Das war\'s!** ï¿½ï¿½',
            '',
            '## ğŸ”§ Performance-Verbesserungen in dieser Version',
            '',
            '- âš¡ **70% schnellere Startzeit** durch optimierte Initialisierung',
            '- ğŸ”„ **Paralleles Laden** aller Bot-Komponenten',
            '- ğŸ¯ **Lazy Loading** - Komponenten werden erst bei Bedarf geladen',
            '- â±ï¸ **Smart Timeouts** - Bot hÃ¤ngt sich nicht mehr beim Start auf',
            '- ğŸ“Š **Detailliertes Performance-Monitoring** in den Logs',
            '',
            '## ğŸ”‘ Bot-Tokens erstellen',
            '',
            '1. Gehe zu [Discord Developer Portal](https://discord.com/developers/applications)',
            '2. Erstelle zwei neue Applications',
            '3. Gehe zu "Bot" â†’ "Reset Token" fÃ¼r jeden Bot',
            '4. Kopiere die Tokens und gib sie beim ersten Start ein',
            '',
            '## ğŸ› Problembehandlung',
            '',
            '- **Token-Probleme**: LÃ¶sche die `.env` Datei und starte erneut fÃ¼r neue Token-Eingabe',
            '- **"Import Error"**: Nutze die EXE-Version oder installiere `pip install -r requirements.txt`',
            '- **Bot startet nicht**: ÃœberprÃ¼fe Internetverbindung und Token-GÃ¼ltigkeit',
            '- **Weitere Hilfe**: [Discord Server](https://discord.gg/pokemonhideout)'
          ].join('\n');
          
          await github.rest.repos.updateRelease({
            owner,
            repo,
            release_id: release.data.id,
            body: release.data.body + additionalNotes
          });
          
          console.log('Release Notes aktualisiert fÃ¼r ' + tagName);