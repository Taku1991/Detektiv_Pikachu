name: ğŸš€ Build and Release

on:
  release:
    types: [published]
  workflow_dispatch: # Erlaubt manuelles Triggern

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”¨ Build Executables
      run: |
        python build_exe.py
        
    - name: ğŸ“ Create Release Archive
      run: |
        Compress-Archive -Path release\* -DestinationPath DetektivPikachu-Windows-${{ github.ref_name }}.zip
        
    - name: ğŸ“Š Get Release Info
      run: |
        Get-ChildItem release\ -Recurse | Select-Object Name, Length | Format-Table
        
    - name: ğŸ”¼ Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./DetektivPikachu-Windows-${{ github.ref_name }}.zip
        asset_name: DetektivPikachu-Windows-${{ github.ref_name }}.zip
        asset_content_type: application/zip

  build-info:
    runs-on: ubuntu-latest
    needs: build-windows
    
    steps:
    - name: ğŸ“ Update Release Notes
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const release = await github.rest.repos.getRelease({
            owner,
            repo,
            release_id: context.payload.release.id
          });
          
          const additionalNotes = `
          
          ## ğŸ“¦ Installation (Windows EXE)
          
          1. **Lade die ZIP-Datei herunter**: \`DetektivPikachu-Windows-${{ github.ref_name }}.zip\`
          2. **Entpacke** die Datei in einen Ordner deiner Wahl
          3. **Konfiguration**:
             - Kopiere \`config/.env.example\` nach \`config/.env\`
             - FÃ¼lle deine Discord Bot-Tokens in die \`.env\`-Datei ein
          4. **Starten**:
             - Doppelklick auf \`start_both_bots.bat\` (startet beide Bots)
             - Oder einzeln: \`start_main_bot.bat\` und \`start_helper_bot.bat\`
          
          ## ğŸ“‚ Verzeichnisstruktur nach Installation
          
          \`\`\`
          DetektivPikachu/
          â”œâ”€â”€ ğŸ“ MainBot/              # Haupt-Bot EXE
          â”œâ”€â”€ ğŸ“ HelperBot/            # Helper-Bot EXE  
          â”œâ”€â”€ ğŸ“ config/               # Konfiguration (.env hier ablegen)
          â”œâ”€â”€ ğŸ“ data/                 # Bot-Daten (JSON, Logs, GIFs)
          â”œâ”€â”€ ğŸ“„ start_both_bots.bat   # Beide Bots starten
          â”œâ”€â”€ ğŸ“„ start_main_bot.bat    # Nur Haupt-Bot
          â”œâ”€â”€ ğŸ“„ start_helper_bot.bat  # Nur Helper-Bot
          â”œâ”€â”€ ğŸ“„ README.md
          â””â”€â”€ ğŸ“„ LICENSE
          \`\`\`
          
          ## âœ¨ Features dieser Version
          
          - âœ… **Standalone EXE-Dateien** - Kein Python erforderlich
          - âœ… **Externe Konfiguration** - JSON-Dateien auÃŸerhalb der EXE
          - âœ… **Einfache Installation** - ZIP entpacken und starten
          - âœ… **Automatische Verzeichnisse** - Alle benÃ¶tigten Ordner werden erstellt
          - âœ… **Start-Skripts** - Einfaches Starten mit BAT-Dateien
          
          ## ğŸ”§ Erweiterte Installation (Python)
          
          Wenn du lieber mit Python arbeiten mÃ¶chtest:
          
          \`\`\`bash
          git clone https://github.com/${{ github.repository }}.git
          cd Detektiv_Pikachu
          pip install -r requirements.txt
          # .env-Datei konfigurieren
          python main.py  # Haupt-Bot
          python helper_bot.py  # Helper-Bot
          \`\`\`
          `;
          
          await github.rest.repos.updateRelease({
            owner,
            repo,
            release_id: context.payload.release.id,
            body: release.data.body + additionalNotes
          }); 